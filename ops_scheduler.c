/** @brief   Example scheduler
 *  @file    ops_scheduler.c
 *  @author  harryzwh @ USYD
 *  @version 1.0.0
 *  @date    2018/10/1
 *  @note    None
 */


#include "stdlib.h"
#include "stdio.h"
#include "string.h"
#include "ops_agent.h"
#include "ops_scheduler.h"
#include "float.h"
#include "limits.h"


//#define SCHED_DEBUG

#define NO_UE_SELECTED          (-1)    ///< Flag if all UEs are satisfied
#define NO_BEARER_SELECTED      (-1)    ///< Flag if all DRBs are satisfied
#define OPS_THROUGHPUT_COEFF	99      ///< Coefficient to calculate average throughput (smaller -> more sensitive)
#define OPS_MAX_NUM_RB          110     ///< Maximum number of RBs in TBS table (should not be changed)
#define OPS_MAX_MCS             28      ///< Maximum MCS (can be changed in [0...28])

int Num_Rest_RBG;   ///< Number of available RBGs
int Num_Total_RBG;  ///< Number of total RBGs
int RBG_Size;       ///< Number of RBs in normal RBGs
int Last_RBG_Size;  ///< Number of RBs in the last RBG


void OPS_PDSCH_Scheduler(void)
{
    OPS_PDSCH_Scheduler_dll(&OPS_Agent);
}

void OPS_PDSCH_Scheduler_dll(struct sOPS_Agent* OPS_Agent)
{
    //OPS_Agent->System_Info.RBG_Available_Bit_Mask&=0x000000FF;
    double Metric[OPS_MAX_NUM_UE];
    double Metric_Bearer[OPS_MAX_NUM_RAB];
    int Num_Required_RB[OPS_MAX_NUM_UE];
    int Selected_UE, Selected_Bearer;
    OPS_BW2RB_RBG(OPS_Agent->System_Info.Bandwidth, &RBG_Size, &Last_RBG_Size, &Num_Rest_RBG, &Num_Total_RBG);
    memset(Metric, 0, sizeof(Metric));
    memset(Metric_Bearer, 0, sizeof(Metric_Bearer));
    memset(Num_Required_RB, 0, sizeof(Num_Required_RB));

    //preprocessing
    OPS_Update_Average_Throughput(OPS_Agent);
    OPS_Set_MCS(OPS_Agent);
    OPS_Find_Num_Required_RB(OPS_Agent, Num_Required_RB);

    //allocate RBG one by one
    for (int RBG_Idx = 0; RBG_Idx < Num_Total_RBG; RBG_Idx++)
    {
        // find available RBG
        if (!((OPS_Agent->System_Info.RBG_Available_Bit_Mask >> RBG_Idx) & 0x00000001))
        {
            continue;
        }

        // update metric for UE selection
        OPS_UE_Selection_Metric_RR(OPS_Agent, Metric);
        //OPS_UE_Selection_Metric_PF(OPS_Agent, Metric);
        //OPS_UE_Selection_Metric_TP(OPS_Agent, Metric);
        Selected_UE = OPS_Find_Selected_UE(OPS_Agent, Metric, Num_Required_RB);

        // allocated 1 RBG
        if (Selected_UE != NO_UE_SELECTED)
        {
            OPS_Agent->UE_Info[Selected_UE].RBG_Allocation_Bit_Mask |= (1 << RBG_Idx);
            OPS_Adjust_MCS(OPS_Agent, Selected_UE);
        } else
        {
            break;
        }
    }

    //DRB allocation
    for (int UE_id = 0; UE_id < OPS_MAX_NUM_UE; UE_id++)
    {
        if (!OPS_Agent->UE_Info[UE_id].Active)
        {
            continue;
        }
        //allocate all SRB first
        int Rest_TBS = OPS_MCS2TBS(OPS_Agent->UE_Info[UE_id].MCS, OPS_Num_Allocated_RB(OPS_Agent, UE_id));
        for (int LCID = 0; LCID < OPS_DRB_LCID_OFFSET; LCID++)
        {
            if (OPS_Agent->UE_Info[UE_id].Bearer_Info[LCID].Active)
            {
                Rest_TBS -= OPS_Agent->UE_Info[UE_id].Bearer_Info[LCID].Num_Byte_In_Buffer;
                OPS_Agent->UE_Info[UE_id].Bearer_Info[LCID].Num_Byte_Tx = OPS_Agent->UE_Info[UE_id].Bearer_Info[LCID].Num_Byte_In_Buffer;
            }
        }
        //allocate byte one by one
        for (int N_Byte = 0; N_Byte < Rest_TBS; N_Byte++)
        {
            OPS_Bearer_Selection_Metric_TP(OPS_Agent, Metric_Bearer, UE_id);
            Selected_Bearer = OPS_Find_Selected_Bearer(OPS_Agent, Metric_Bearer, UE_id);
            // allocate 1 byte
            if (Selected_Bearer != NO_BEARER_SELECTED)
            {
                OPS_Agent->UE_Info[UE_id].Bearer_Info[Selected_Bearer].Num_Byte_Tx++;
            } else
            {
                break;
            }
        }
    }
}


void OPS_UE_Selection_Metric_RR(struct sOPS_Agent* OPS_Agent, double* Metric)
{
    for (int UE_id=0;UE_id<OPS_MAX_NUM_UE;UE_id++)
    {
        if (OPS_Agent->UE_Info[UE_id].Active)
        {
            Metric[UE_id]=-OPS_Hamming_Weight(OPS_Agent->UE_Info[UE_id].RBG_Allocation_Bit_Mask);
        }
    }
}


void OPS_UE_Selection_Metric_PF(struct sOPS_Agent* OPS_Agent, double* Metric)
{
    for (int UE_id=0;UE_id<OPS_MAX_NUM_UE;UE_id++)
    {
        if (OPS_Agent->UE_Info[UE_id].Active)
        {
            int Instant_Rate=OPS_CQI2Byte(OPS_Agent->UE_Info[UE_id].CQI);
            double Est_Avg_Rate=(OPS_Num_Allocated_RB(OPS_Agent,UE_id)*OPS_CQI2Byte(OPS_Agent->UE_Info[UE_id].CQI)
                                 +OPS_Agent->UE_Info[UE_id].Avg_Num_Tx_Byte*OPS_THROUGHPUT_COEFF)/(OPS_THROUGHPUT_COEFF+1.0);
            Metric[UE_id]=Instant_Rate/Est_Avg_Rate;
        }
    }
}

void OPS_UE_Selection_Metric_TP(struct sOPS_Agent* OPS_Agent, double* Metric)
{
    for (int UE_id=0;UE_id<OPS_MAX_NUM_UE;UE_id++)
    {
        if (OPS_Agent->UE_Info[UE_id].Active)
        {
            int Weight=OPS_Agent->UE_Info[UE_id].Bearer_Info[OPS_DRB_LCID_OFFSET].QCI==9?2:1;
            Metric[UE_id]=-Weight*OPS_Hamming_Weight(OPS_Agent->UE_Info[UE_id].RBG_Allocation_Bit_Mask);
        }
    }
}




void OPS_BW2RB_RBG(int Bandwidth, int* RBG_Size, int* Last_RBG_Size, int* Num_Rest_RBG, int* Num_Total_RBG)
{
    static int Num_RBG_Table[] = {6, 8, 13, 17, 19, 25};
    static int RBG_Size_Table[] = {1, 2, 2, 3, 4, 4};
    static int Last_RBG_Size_Table[] = {1, 1, 1, 2, 3, 4};
    int Num_RBG_Temp=0;
    if ((Bandwidth>=OPS_BW_1)&&(Bandwidth<=OPS_BW_20))
    {
        *RBG_Size = RBG_Size_Table[Bandwidth];
        *Last_RBG_Size = Last_RBG_Size_Table[Bandwidth];
        *Num_Total_RBG=Num_RBG_Table[Bandwidth];
    }
    else
    {
        *RBG_Size = 0;
        *Last_RBG_Size =0;
        *Num_Rest_RBG=0;
        return;
    }
    for (int i=0;i<*Num_Total_RBG;i++)
    {
        if ((OPS_Agent.System_Info.RBG_Available_Bit_Mask>>i)&0x00000001)
        {
            Num_RBG_Temp++;
        }
    }
    *Num_Rest_RBG=Num_RBG_Temp;
}

int OPS_CQI2Byte(int CQI)
{
    static int CQI_Byte_Table[]={0,2,4,6,10,14,19,24,31,39,44,53,62,72,82,89};
    return (CQI_Byte_Table[CQI]);
}

int OPS_Hamming_Weight(int n)
{
    n = (n&0x55555555) + ((n>>1)&0x55555555);
    n = (n&0x33333333) + ((n>>2)&0x33333333);
    n = (n&0x0f0f0f0f) + ((n>>4)&0x0f0f0f0f);
    n = (n&0x00ff00ff) + ((n>>8)&0x00ff00ff);
    n = (n&0x0000ffff) + ((n>>16)&0x0000ffff);
    return n;
}

int OPS_Num_Allocated_RB(struct sOPS_Agent* OPS_Agent, int UE_id)
{
    int Num_RB=OPS_Hamming_Weight(OPS_Agent->UE_Info[UE_id].RBG_Allocation_Bit_Mask)*RBG_Size;
    if ((OPS_Agent->UE_Info[UE_id].RBG_Allocation_Bit_Mask>>Num_Total_RBG)&0x00000001)
    {
        Num_RB=Num_RB-RBG_Size+Last_RBG_Size;
    }
    return Num_RB;
}

void OPS_Update_Average_Throughput(struct sOPS_Agent* OPS_Agent)
{
    for (int UE_id=0;UE_id<OPS_MAX_NUM_UE;UE_id++)
    {
        if (OPS_Agent->UE_Info[UE_id].Active)
        {
            OPS_Agent->UE_Info[UE_id].Avg_Num_Tx_Byte=(OPS_Agent->UE_Info[UE_id].Num_Tx_Byte_TTI
                                                       +OPS_Agent->UE_Info[UE_id].Avg_Num_Tx_Byte*OPS_THROUGHPUT_COEFF)/(OPS_THROUGHPUT_COEFF+1);
            if (OPS_Agent->UE_Info[UE_id].Avg_Num_Tx_Byte<1)
            {
                OPS_Agent->UE_Info[UE_id].Avg_Num_Tx_Byte=1;
            }
        }
    }
}

int OPS_CQI2MCS(int CQI)
{
    static int CQI_MCS_Table[16]= {0, 0, 1, 2, 4, 6, 8, 11, 13, 16, 18, 20, 23, 25, 27, 28};
    return (CQI_MCS_Table[CQI]);
}

int OPS_MCS2TBS(int MCS, int N_RB)
{
    static unsigned int TBStable[27][110] = {
            {16,32,56,88,120,152,176,208,224,256,288,328,344,376,392,424,456,488,504,536,568,600,616,648,680,712,744,776,776,808,840,872,904,936,968,1000,1032,1032,1064,1096,1128,1160,1192,1224,1256,1256,1288,1320,1352,1384,1416,1416,1480,1480,1544,1544,1608,1608,1608,1672,1672,1736,1736,1800,1800,1800,1864,1864,1928,1928,1992,1992,2024,2088,2088,2088,2152,2152,2216,2216,2280,2280,2280,2344,2344,2408,2408,2472,2472,2536,2536,2536,2600,2600,2664,2664,2728,2728,2728,2792,2792,2856,2856,2856,2984,2984,2984,2984,2984,3112},
            {24,56,88,144,176,208,224,256,328,344,376,424,456,488,520,568,600,632,680,712,744,776,808,872,904,936,968,1000,1032,1064,1128,1160,1192,1224,1256,1288,1352,1384,1416,1416,1480,1544,1544,1608,1608,1672,1736,1736,1800,1800,1864,1864,1928,1992,1992,2024,2088,2088,2152,2152,2216,2280,2280,2344,2344,2408,2472,2472,2536,2536,2600,2600,2664,2728,2728,2792,2792,2856,2856,2856,2984,2984,2984,3112,3112,3112,3240,3240,3240,3240,3368,3368,3368,3496,3496,3496,3496,3624,3624,3624,3752,3752,3752,3752,3880,3880,3880,4008,4008,4008},
            {32,72,144,176,208,256,296,328,376,424,472,520,568,616,648,696,744,776,840,872,936,968,1000,1064,1096,1160,1192,1256,1288,1320,1384,1416,1480,1544,1544,1608,1672,1672,1736,1800,1800,1864,1928,1992,2024,2088,2088,2152,2216,2216,2280,2344,2344,2408,2472,2536,2536,2600,2664,2664,2728,2792,2856,2856,2856,2984,2984,3112,3112,3112,3240,3240,3240,3368,3368,3368,3496,3496,3496,3624,3624,3624,3752,3752,3880,3880,3880,4008,4008,4008,4136,4136,4136,4264,4264,4264,4392,4392,4392,4584,4584,4584,4584,4584,4776,4776,4776,4776,4968,4968},
            {40,104,176,208,256,328,392,440,504,568,616,680,744,808,872,904,968,1032,1096,1160,1224,1256,1320,1384,1416,1480,1544,1608,1672,1736,1800,1864,1928,1992,2024,2088,2152,2216,2280,2344,2408,2472,2536,2536,2600,2664,2728,2792,2856,2856,2984,2984,3112,3112,3240,3240,3368,3368,3496,3496,3624,3624,3624,3752,3752,3880,3880,4008,4008,4136,4136,4264,4264,4392,4392,4392,4584,4584,4584,4776,4776,4776,4776,4968,4968,4968,5160,5160,5160,5352,5352,5352,5352,5544,5544,5544,5736,5736,5736,5736,5992,5992,5992,5992,6200,6200,6200,6200,6456,6456},
            {56,120,208,256,328,408,488,552,632,696,776,840,904,1000,1064,1128,1192,1288,1352,1416,1480,1544,1608,1736,1800,1864,1928,1992,2088,2152,2216,2280,2344,2408,2472,2600,2664,2728,2792,2856,2984,2984,3112,3112,3240,3240,3368,3496,3496,3624,3624,3752,3752,3880,4008,4008,4136,4136,4264,4264,4392,4392,4584,4584,4584,4776,4776,4968,4968,4968,5160,5160,5160,5352,5352,5544,5544,5544,5736,5736,5736,5992,5992,5992,5992,6200,6200,6200,6456,6456,6456,6456,6712,6712,6712,6968,6968,6968,6968,7224,7224,7224,7480,7480,7480,7480,7736,7736,7736,7992},
            {72,144,224,328,424,504,600,680,776,872,968,1032,1128,1224,1320,1384,1480,1544,1672,1736,1864,1928,2024,2088,2216,2280,2344,2472,2536,2664,2728,2792,2856,2984,3112,3112,3240,3368,3496,3496,3624,3752,3752,3880,4008,4008,4136,4264,4392,4392,4584,4584,4776,4776,4776,4968,4968,5160,5160,5352,5352,5544,5544,5736,5736,5736,5992,5992,5992,6200,6200,6200,6456,6456,6712,6712,6712,6968,6968,6968,7224,7224,7224,7480,7480,7480,7736,7736,7736,7992,7992,7992,8248,8248,8248,8504,8504,8760,8760,8760,8760,9144,9144,9144,9144,9528,9528,9528,9528,9528},
            {328,176,256,392,504,600,712,808,936,1032,1128,1224,1352,1480,1544,1672,1736,1864,1992,2088,2216,2280,2408,2472,2600,2728,2792,2984,2984,3112,3240,3368,3496,3496,3624,3752,3880,4008,4136,4136,4264,4392,4584,4584,4776,4776,4968,4968,5160,5160,5352,5352,5544,5736,5736,5992,5992,5992,6200,6200,6456,6456,6456,6712,6712,6968,6968,6968,7224,7224,7480,7480,7736,7736,7736,7992,7992,8248,8248,8248,8504,8504,8760,8760,8760,9144,9144,9144,9144,9528,9528,9528,9528,9912,9912,9912,10296,10296,10296,10296,10680,10680,10680,10680,11064,11064,11064,11448,11448,11448},
            {104,224,328,472,584,712,840,968,1096,1224,1320,1480,1608,1672,1800,1928,2088,2216,2344,2472,2536,2664,2792,2984,3112,3240,3368,3368,3496,3624,3752,3880,4008,4136,4264,4392,4584,4584,4776,4968,4968,5160,5352,5352,5544,5736,5736,5992,5992,6200,6200,6456,6456,6712,6712,6712,6968,6968,7224,7224,7480,7480,7736,7736,7992,7992,8248,8248,8504,8504,8760,8760,8760,9144,9144,9144,9528,9528,9528,9912,9912,9912,10296,10296,10296,10680,10680,10680,11064,11064,11064,11448,11448,11448,11448,11832,11832,11832,12216,12216,12216,12576,12576,12576,12960,12960,12960,12960,13536,13536},
            {120,256,392,536,680,808,968,1096,1256,1384,1544,1672,1800,1928,2088,2216,2344,2536,2664,2792,2984,3112,3240,3368,3496,3624,3752,3880,4008,4264,4392,4584,4584,4776,4968,4968,5160,5352,5544,5544,5736,5992,5992,6200,6200,6456,6456,6712,6968,6968,7224,7224,7480,7480,7736,7736,7992,7992,8248,8504,8504,8760,8760,9144,9144,9144,9528,9528,9528,9912,9912,9912,10296,10296,10680,10680,10680,11064,11064,11064,11448,11448,11448,11832,11832,12216,12216,12216,12576,12576,12576,12960,12960,12960,13536,13536,13536,13536,14112,14112,14112,14112,14688,14688,14688,14688,15264,15264,15264,15264},
            {136,296,456,616,776,936,1096,1256,1416,1544,1736,1864,2024,2216,2344,2536,2664,2856,2984,3112,3368,3496,3624,3752,4008,4136,4264,4392,4584,4776,4968,5160,5160,5352,5544,5736,5736,5992,6200,6200,6456,6712,6712,6968,6968,7224,7480,7480,7736,7992,7992,8248,8248,8504,8760,8760,9144,9144,9144,9528,9528,9912,9912,10296,10296,10296,10680,10680,11064,11064,11064,11448,11448,11832,11832,11832,12216,12216,12576,12576,12960,12960,12960,13536,13536,13536,13536,14112,14112,14112,14112,14688,14688,14688,15264,15264,15264,15264,15840,15840,15840,16416,16416,16416,16416,16992,16992,16992,16992,17568},
            {144,328,504,680,872,1032,1224,1384,1544,1736,1928,2088,2280,2472,2664,2792,2984,3112,3368,3496,3752,3880,4008,4264,4392,4584,4776,4968,5160,5352,5544,5736,5736,5992,6200,6200,6456,6712,6712,6968,7224,7480,7480,7736,7992,7992,8248,8504,8504,8760,9144,9144,9144,9528,9528,9912,9912,10296,10296,10680,10680,11064,11064,11448,11448,11448,11832,11832,12216,12216,12576,12576,12960,12960,12960,13536,13536,13536,14112,14112,14112,14688,14688,14688,14688,15264,15264,15264,15840,15840,15840,16416,16416,16416,16992,16992,16992,16992,17568,17568,17568,18336,18336,18336,18336,18336,19080,19080,19080,19080},
            {176,376,584,776,1000,1192,1384,1608,1800,2024,2216,2408,2600,2792,2984,3240,3496,3624,3880,4008,4264,4392,4584,4776,4968,5352,5544,5736,5992,5992,6200,6456,6712,6968,6968,7224,7480,7736,7736,7992,8248,8504,8760,8760,9144,9144,9528,9528,9912,9912,10296,10680,10680,11064,11064,11448,11448,11832,11832,12216,12216,12576,12576,12960,12960,13536,13536,13536,14112,14112,14112,14688,14688,14688,15264,15264,15840,15840,15840,16416,16416,16416,16992,16992,16992,17568,17568,17568,18336,18336,18336,18336,19080,19080,19080,19080,19848,19848,19848,19848,20616,20616,20616,21384,21384,21384,21384,22152,22152,22152},
            {208,440,680,904,1128,1352,1608,1800,2024,2280,2472,2728,2984,3240,3368,3624,3880,4136,4392,4584,4776,4968,5352,5544,5736,5992,6200,6456,6712,6712,6968,7224,7480,7736,7992,8248,8504,8760,8760,9144,9528,9528,9912,9912,10296,10680,10680,11064,11064,11448,11832,11832,12216,12216,12576,12576,12960,12960,13536,13536,14112,14112,14112,14688,14688,15264,15264,15264,15840,15840,16416,16416,16416,16992,16992,17568,17568,17568,18336,18336,18336,19080,19080,19080,19080,19848,19848,19848,20616,20616,20616,21384,21384,21384,21384,22152,22152,22152,22920,22920,22920,23688,23688,23688,23688,24496,24496,24496,24496,25456},
            {224,488,744,1000,1256,1544,1800,2024,2280,2536,2856,3112,3368,3624,3880,4136,4392,4584,4968,5160,5352,5736,5992,6200,6456,6712,6968,7224,7480,7736,7992,8248,8504,8760,9144,9144,9528,9912,9912,10296,10680,10680,11064,11448,11448,11832,12216,12216,12576,12960,12960,13536,13536,14112,14112,14688,14688,14688,15264,15264,15840,15840,16416,16416,16992,16992,16992,17568,17568,18336,18336,18336,19080,19080,19080,19848,19848,19848,20616,20616,20616,21384,21384,21384,22152,22152,22152,22920,22920,22920,23688,23688,23688,24496,24496,24496,25456,25456,25456,25456,26416,26416,26416,26416,27376,27376,27376,27376,28336,28336},
            {256,552,840,1128,1416,1736,1992,2280,2600,2856,3112,3496,3752,4008,4264,4584,4968,5160,5544,5736,5992,6200,6456,6968,7224,7480,7736,7992,8248,8504,8760,9144,9528,9912,9912,10296,10680,11064,11064,11448,11832,12216,12216,12576,12960,12960,13536,13536,14112,14112,14688,14688,15264,15264,15840,15840,16416,16416,16992,16992,17568,17568,18336,18336,18336,19080,19080,19848,19848,19848,20616,20616,20616,21384,21384,22152,22152,22152,22920,22920,22920,23688,23688,24496,24496,24496,25456,25456,25456,25456,26416,26416,26416,27376,27376,27376,28336,28336,28336,28336,29296,29296,29296,29296,30576,30576,30576,30576,31704,31704},
            {280,600,904,1224,1544,1800,2152,2472,2728,3112,3368,3624,4008,4264,4584,4968,5160,5544,5736,6200,6456,6712,6968,7224,7736,7992,8248,8504,8760,9144,9528,9912,10296,10296,10680,11064,11448,11832,11832,12216,12576,12960,12960,13536,13536,14112,14688,14688,15264,15264,15840,15840,16416,16416,16992,16992,17568,17568,18336,18336,18336,19080,19080,19848,19848,20616,20616,20616,21384,21384,22152,22152,22152,22920,22920,23688,23688,23688,24496,24496,24496,25456,25456,25456,26416,26416,26416,27376,27376,27376,28336,28336,28336,29296,29296,29296,29296,30576,30576,30576,30576,31704,31704,31704,31704,32856,32856,32856,34008,34008},
            {328,632,968,1288,1608,1928,2280,2600,2984,3240,3624,3880,4264,4584,4968,5160,5544,5992,6200,6456,6712,7224,7480,7736,7992,8504,8760,9144,9528,9912,9912,10296,10680,11064,11448,11832,12216,12216,12576,12960,13536,13536,14112,14112,14688,14688,15264,15840,15840,16416,16416,16992,16992,17568,17568,18336,18336,19080,19080,19848,19848,19848,20616,20616,21384,21384,22152,22152,22152,22920,22920,23688,23688,24496,24496,24496,25456,25456,25456,26416,26416,26416,27376,27376,27376,28336,28336,28336,29296,29296,29296,30576,30576,30576,30576,31704,31704,31704,31704,32856,32856,32856,34008,34008,34008,34008,35160,35160,35160,35160},
            {336,696,1064,1416,1800,2152,2536,2856,3240,3624,4008,4392,4776,5160,5352,5736,6200,6456,6712,7224,7480,7992,8248,8760,9144,9528,9912,10296,10296,10680,11064,11448,11832,12216,12576,12960,13536,13536,14112,14688,14688,15264,15264,15840,16416,16416,16992,17568,17568,18336,18336,19080,19080,19848,19848,20616,20616,20616,21384,21384,22152,22152,22920,22920,23688,23688,24496,24496,24496,25456,25456,26416,26416,26416,27376,27376,27376,28336,28336,29296,29296,29296,30576,30576,30576,30576,31704,31704,31704,32856,32856,32856,34008,34008,34008,35160,35160,35160,35160,36696,36696,36696,36696,37888,37888,37888,39232,39232,39232,39232},
            {376,776,1160,1544,1992,2344,2792,3112,3624,4008,4392,4776,5160,5544,5992,6200,6712,7224,7480,7992,8248,8760,9144,9528,9912,10296,10680,11064,11448,11832,12216,12576,12960,13536,14112,14112,14688,15264,15264,15840,16416,16416,16992,17568,17568,18336,18336,19080,19080,19848,19848,20616,21384,21384,22152,22152,22920,22920,23688,23688,24496,24496,24496,25456,25456,26416,26416,27376,27376,27376,28336,28336,29296,29296,29296,30576,30576,30576,31704,31704,31704,32856,32856,32856,34008,34008,34008,35160,35160,35160,36696,36696,36696,37888,37888,37888,37888,39232,39232,39232,40576,40576,40576,40576,42368,42368,42368,42368,43816,43816},
            {408,840,1288,1736,2152,2600,2984,3496,3880,4264,4776,5160,5544,5992,6456,6968,7224,7736,8248,8504,9144,9528,9912,10296,10680,11064,11448,12216,12576,12960,13536,13536,14112,14688,15264,15264,15840,16416,16992,16992,17568,18336,18336,19080,19080,19848,20616,20616,21384,21384,22152,22152,22920,22920,23688,24496,24496,25456,25456,25456,26416,26416,27376,27376,28336,28336,29296,29296,29296,30576,30576,30576,31704,31704,32856,32856,32856,34008,34008,34008,35160,35160,35160,36696,36696,36696,37888,37888,37888,39232,39232,39232,40576,40576,40576,40576,42368,42368,42368,43816,43816,43816,43816,45352,45352,45352,46888,46888,46888,46888},
            {440,904,1384,1864,2344,2792,3240,3752,4136,4584,5160,5544,5992,6456,6968,7480,7992,8248,8760,9144,9912,10296,10680,11064,11448,12216,12576,12960,13536,14112,14688,14688,15264,15840,16416,16992,16992,17568,18336,18336,19080,19848,19848,20616,20616,21384,22152,22152,22920,22920,23688,24496,24496,25456,25456,26416,26416,27376,27376,28336,28336,29296,29296,29296,30576,30576,31704,31704,31704,32856,32856,34008,34008,34008,35160,35160,35160,36696,36696,36696,37888,37888,39232,39232,39232,40576,40576,40576,42368,42368,42368,42368,43816,43816,43816,45352,45352,45352,46888,46888,46888,46888,48936,48936,48936,48936,48936,51024,51024,51024},
            {488,1000,1480,1992,2472,2984,3496,4008,4584,4968,5544,5992,6456,6968,7480,7992,8504,9144,9528,9912,10680,11064,11448,12216,12576,12960,13536,14112,14688,15264,15840,15840,16416,16992,17568,18336,18336,19080,19848,19848,20616,21384,21384,22152,22920,22920,23688,24496,24496,25456,25456,26416,26416,27376,27376,28336,28336,29296,29296,30576,30576,31704,31704,31704,32856,32856,34008,34008,35160,35160,35160,36696,36696,36696,37888,37888,39232,39232,39232,40576,40576,40576,42368,42368,42368,43816,43816,43816,45352,45352,45352,46888,46888,46888,46888,48936,48936,48936,48936,51024,51024,51024,51024,52752,52752,52752,52752,55056,55056,55056},
            {520,1064,1608,2152,2664,3240,3752,4264,4776,5352,5992,6456,6968,7480,7992,8504,9144,9528,10296,10680,11448,11832,12576,12960,13536,14112,14688,15264,15840,16416,16992,16992,17568,18336,19080,19080,19848,20616,21384,21384,22152,22920,22920,23688,24496,24496,25456,25456,26416,27376,27376,28336,28336,29296,29296,30576,30576,31704,31704,32856,32856,34008,34008,34008,35160,35160,36696,36696,36696,37888,37888,39232,39232,40576,40576,40576,42368,42368,42368,43816,43816,43816,45352,45352,45352,46888,46888,46888,48936,48936,48936,48936,51024,51024,51024,51024,52752,52752,52752,55056,55056,55056,55056,57336,57336,57336,57336,59256,59256,59256},
            {552,1128,1736,2280,2856,3496,4008,4584,5160,5736,6200,6968,7480,7992,8504,9144,9912,10296,11064,11448,12216,12576,12960,13536,14112,14688,15264,15840,16416,16992,17568,18336,19080,19848,19848,20616,21384,22152,22152,22920,23688,24496,24496,25456,25456,26416,27376,27376,28336,28336,29296,29296,30576,30576,31704,31704,32856,32856,34008,34008,35160,35160,36696,36696,37888,37888,37888,39232,39232,40576,40576,40576,42368,42368,43816,43816,43816,45352,45352,45352,46888,46888,46888,48936,48936,48936,51024,51024,51024,51024,52752,52752,52752,55056,55056,55056,55056,57336,57336,57336,57336,59256,59256,59256,59256,61664,61664,61664,61664,63776},
            {584,1192,1800,2408,2984,3624,4264,4968,5544,5992,6712,7224,7992,8504,9144,9912,10296,11064,11448,12216,12960,13536,14112,14688,15264,15840,16416,16992,17568,18336,19080,19848,19848,20616,21384,22152,22920,22920,23688,24496,25456,25456,26416,26416,27376,28336,28336,29296,29296,30576,31704,31704,32856,32856,34008,34008,35160,35160,36696,36696,36696,37888,37888,39232,39232,40576,40576,42368,42368,42368,43816,43816,45352,45352,45352,46888,46888,46888,48936,48936,48936,51024,51024,51024,52752,52752,52752,52752,55056,55056,55056,57336,57336,57336,57336,59256,59256,59256,61664,61664,61664,61664,63776,63776,63776,63776,66592,66592,66592,66592},
            {616,1256,1864,2536,3112,3752,4392,5160,5736,6200,6968,7480,8248,8760,9528,10296,10680,11448,12216,12576,13536,14112,14688,15264,15840,16416,16992,17568,18336,19080,19848,20616,20616,21384,22152,22920,23688,24496,24496,25456,26416,26416,27376,28336,28336,29296,29296,30576,31704,31704,32856,32856,34008,34008,35160,35160,36696,36696,37888,37888,39232,39232,40576,40576,40576,42368,42368,43816,43816,43816,45352,45352,46888,46888,46888,48936,48936,48936,51024,51024,51024,52752,52752,52752,55056,55056,55056,55056,57336,57336,57336,59256,59256,59256,61664,61664,61664,61664,63776,63776,63776,63776,66592,66592,66592,66592,68808,68808,68808,71112},
            {712,1480,2216,2984,3752,4392,5160,5992,6712,7480,8248,8760,9528,10296,11064,11832,12576,13536,14112,14688,15264,16416,16992,17568,18336,19080,19848,20616,21384,22152,22920,23688,24496,25456,25456,26416,27376,28336,29296,29296,30576,30576,31704,32856,32856,34008,35160,35160,36696,36696,37888,37888,39232,40576,40576,40576,42368,42368,43816,43816,45352,45352,46888,46888,48936,48936,48936,51024,51024,52752,52752,52752,55056,55056,55056,55056,57336,57336,57336,59256,59256,59256,61664,61664,61664,63776,63776,63776,66592,66592,66592,68808,68808,68808,71112,71112,71112,73712,73712,75376,75376,75376,75376,75376,75376,75376,75376,75376,75376,75376}};

    int TBS_Idx;
    if (MCS<=9)
    {
        TBS_Idx=MCS;
    }
    else if (MCS<=16)
    {
        TBS_Idx=MCS-1;
    }
    else
    {
        TBS_Idx=MCS-2;
    }
    return TBStable[TBS_Idx][N_RB-1]>>3;
}

void OPS_Set_MCS(struct sOPS_Agent* OPS_Agent)
{
    for (int UE_id=0;UE_id<OPS_MAX_NUM_UE;UE_id++)
    {
        if (OPS_Agent->UE_Info[UE_id].Active)
        {
            OPS_Agent->UE_Info[UE_id].MCS = OPS_CQI2MCS(OPS_Agent->UE_Info[UE_id].CQI);
            OPS_Agent->UE_Info[UE_id].MCS=OPS_Agent->UE_Info[UE_id].MCS>OPS_MAX_MCS?OPS_MAX_MCS:OPS_Agent->UE_Info[UE_id].MCS;
        }
    }
}

void OPS_Find_Num_Required_RB(struct sOPS_Agent *OPS_Agent, int *Num_Required_RB)
{
    int Total_payload, Num_Required_RB_Temp;
    for (int UE_id = 0; UE_id < OPS_MAX_NUM_UE; UE_id++)
    {
        if (!OPS_Agent->UE_Info[UE_id].Active)
        {
            continue;
        }
        //calculate total pdu size
        Total_payload = 0;
        for (int RAB_Idx = 0; RAB_Idx < OPS_MAX_NUM_RAB; RAB_Idx++)
        {
            if (OPS_Agent->UE_Info[UE_id].Bearer_Info[RAB_Idx].Active)
            {
                Total_payload += OPS_Agent->UE_Info[UE_id].Bearer_Info[RAB_Idx].Num_Byte_In_Buffer;
            }
        }

        //calculate RB demand
        if (Total_payload > 0)
        {
            Num_Required_RB_Temp = RBG_Size;
            while (OPS_MCS2TBS(OPS_Agent->UE_Info[UE_id].MCS, Num_Required_RB_Temp) < Total_payload)
            {
                Num_Required_RB_Temp++;
                if (Num_Required_RB_Temp >= OPS_MAX_NUM_RB)
                {
                    break;
                }
            }
            OPS_Agent->UE_Info[UE_id].Required_nof_RB = Num_Required_RB_Temp;
            Num_Required_RB[UE_id] = Num_Required_RB_Temp;
        } else
        {
            OPS_Agent->UE_Info[UE_id].Required_nof_RB = 0;
            Num_Required_RB[UE_id] = 0;
        }
    }
}

int OPS_Find_Selected_UE(struct sOPS_Agent* OPS_Agent, double* Metric, int* Num_Required_RB)
{
    double Current_Max_Metric=INT_MIN;
    int Selected_UE=NO_UE_SELECTED;
    for (int UE_id=0; UE_id<OPS_MAX_NUM_UE;UE_id++)
    {
        int Remaining_Num_RB=Num_Required_RB[UE_id]-OPS_Num_Allocated_RB(OPS_Agent,UE_id);
        if ((OPS_Agent->UE_Info[UE_id].Active)&&(Remaining_Num_RB>0))
        {
            if (Metric[UE_id]>Current_Max_Metric)
            {
                Current_Max_Metric=Metric[UE_id];
                Selected_UE=UE_id;
            }
        }
    }
    return Selected_UE;
}

void OPS_Bearer_Selection_Metric_TP(struct sOPS_Agent* OPS_Agent, double* Metric, int UE_id)
{
    for (int LCID=OPS_DRB_LCID_OFFSET; LCID<OPS_MAX_NUM_RAB;LCID++)
    {
        if (OPS_Agent->UE_Info[UE_id].Bearer_Info[LCID].Active)
        {
            int Weigth=OPS_Agent->UE_Info[UE_id].Bearer_Info[LCID].QCI==9?3:1;
            Metric[LCID]=-Weigth*OPS_Agent->UE_Info[UE_id].Bearer_Info[LCID].Num_Byte_Tx;
        }
    }
}

int OPS_Find_Selected_Bearer(struct sOPS_Agent* OPS_Agent, double* Metric, int UE_id)
{
    double Current_Max_Metric=INT_MIN;
    int Selected_Bearer=NO_BEARER_SELECTED;
    for (int LCID=OPS_DRB_LCID_OFFSET; LCID<OPS_MAX_NUM_RAB;LCID++)
    {
        if ((OPS_Agent->UE_Info[UE_id].Bearer_Info[LCID].Active)
            &&(OPS_Agent->UE_Info[UE_id].Bearer_Info[LCID].Num_Byte_In_Buffer>OPS_Agent->UE_Info[UE_id].Bearer_Info[LCID].Num_Byte_Tx))
        {
            if (Metric[LCID]>Current_Max_Metric)
            {
                Current_Max_Metric=Metric[LCID];
                Selected_Bearer=LCID;
            }
        }
    }
    return Selected_Bearer;
}

void OPS_Adjust_MCS(struct sOPS_Agent* OPS_Agent, int UE_id)
{
    int Total_payload=0;
    for (int RAB_Idx=0; RAB_Idx<OPS_MAX_NUM_RAB; RAB_Idx++)
    {
        if (OPS_Agent->UE_Info[UE_id].Bearer_Info[RAB_Idx].Active)
        {
            Total_payload+=OPS_Agent->UE_Info[UE_id].Bearer_Info[RAB_Idx].Num_Byte_In_Buffer;
        }
    }
    while ((OPS_Agent->UE_Info[UE_id].MCS>0)&&(OPS_MCS2TBS(OPS_Agent->UE_Info[UE_id].MCS-1,OPS_Num_Allocated_RB(OPS_Agent,UE_id))>Total_payload))
    {
        OPS_Agent->UE_Info[UE_id].MCS--;
    }
}